# ============================================
# Docker Compose with Environment Variables
# ============================================
# This file demonstrates how to use environment variables in Docker Compose
# Environment variables are substituted using ${VAR} syntax
# Default values can be provided using ${VAR:-default} syntax

# Docker Compose file format version
# Version 3.8 supports most modern Docker features
version: '3.8'

# ============================================
# Services Definition
# ============================================
# Each service represents a container that will be started
services:
  
  # ----------------------------------------
  # Web Application Service (Nginx)
  # ----------------------------------------
  web:
    # Docker image to use for this service
    # nginx:alpine is a lightweight Nginx web server
    image: nginx:alpine
    
    # Container name with environment variable substitution
    # ${APP_NAME:-myapp} means: use APP_NAME from .env, or "myapp" if not set
    # Result: "myapp_web" or "{APP_NAME}_web" (e.g., "production_web")
    container_name: ${APP_NAME:-myapp}_web
    
    # Port mapping: host_port:container_port
    # ${WEB_PORT:-80}:80 means: use WEB_PORT from .env, default to 80
    # Maps host port 80 (or custom) to container port 80
    # ${WEB_HTTPS_PORT:-443}:443 maps HTTPS port similarly
    ports:
      - "${WEB_PORT:-80}:80"              # HTTP port mapping
      - "${WEB_HTTPS_PORT:-443}:443"       # HTTPS port mapping
    
    # Environment variables passed directly to the container
    # These override any values from .env file
    # ${NODE_ENV:-production} uses NODE_ENV or defaults to "production"
    environment:
      - NODE_ENV=${NODE_ENV:-production}   # Runtime environment (dev/staging/prod)
      - API_URL=${API_URL}                  # API endpoint URL (required, no default)
      - API_KEY=${API_KEY}                  # API authentication key (required, no default)
    
    # Load additional environment variables from .env file
    # All variables in .env will be available in the container
    # This is useful for loading many variables at once
    env_file:
      - .env                                # Path to environment file
    
    # Volume mounts: host_path:container_path
    # Maps ./web directory on host to /usr/share/nginx/html in container
    # This allows serving static files from local directory
    volumes:
      - ./web:/usr/share/nginx/html        # Mount web files directory
    
    # Restart policy: container restarts automatically unless manually stopped
    # Options: no, always, on-failure, unless-stopped
    restart: unless-stopped
    
    # Network connection: connects to app-network for service communication
    networks:
      - app-network

  # ----------------------------------------
  # API Service (Backend Application)
  # ----------------------------------------
  api:
    # Build instructions: build from local Dockerfile instead of using pre-built image
    # This allows custom application code to be containerized
    build:
      context: ./api                                    # Build context directory
      dockerfile: Dockerfile                            # Dockerfile name (in context dir)
    
    # Container name using APP_NAME variable
    # Result: "myapp_api" or "{APP_NAME}_api"
    container_name: ${APP_NAME:-myapp}_api
    
    # Port mapping for API service
    # ${API_PORT:-3000}:3000 maps custom host port (or 3000) to container port 3000
    ports:
      - "${API_PORT:-3000}:3000"                        # API service port (default: 3000)
    
    # Environment variables for API service configuration
    # These are required for the application to connect to services
    environment:
      - NODE_ENV=${NODE_ENV:-production}                # Node.js environment
      - DATABASE_URL=${DATABASE_URL}                     # Full database connection string
      - REDIS_URL=${REDIS_URL}                           # Redis connection URL
      - JWT_SECRET=${JWT_SECRET}                         # Secret key for JWT tokens
      - API_KEY=${API_KEY}                               # API authentication key
    
    # Load additional variables from .env file
    env_file:
      - .env
    
    # Service dependencies: api will wait for db and redis to be ready
    # Docker Compose starts services in dependency order
    depends_on:
      - db                                              # Wait for database service
      - redis                                           # Wait for Redis service
    
    # Auto-restart policy
    restart: unless-stopped
    
    # Connect to application network for service-to-service communication
    networks:
      - app-network

  # ----------------------------------------
  # Database Service (PostgreSQL)
  # ----------------------------------------
  db:
    # PostgreSQL 15 Alpine image (lightweight Linux-based database)
    image: postgres:15-alpine
    
    # Container name with APP_NAME substitution
    container_name: ${APP_NAME:-myapp}_db
    
    # PostgreSQL-specific environment variables
    # These configure the database instance on first startup
    environment:
      POSTGRES_DB: ${DB_NAME}                           # Database name (from .env)
      POSTGRES_USER: ${DB_USER}                         # Database superuser (from .env)
      POSTGRES_PASSWORD: ${DB_PASSWORD}                 # Database password (from .env)
    
    # Named volume for persistent data storage
    # postgres_data is a named volume managed by Docker
    # Data persists even if container is removed
    volumes:
      - postgres_data:/var/lib/postgresql/data           # PostgreSQL data directory
    
    # Expose database port to host
    # ${DB_PORT:-5432}:5432 allows external connections (optional)
    # Default PostgreSQL port is 5432
    ports:
      - "${DB_PORT:-5432}:5432"                         # Database port mapping
    
    # Auto-restart policy
    restart: unless-stopped
    
    # Network connection
    networks:
      - app-network
    
    # Health check: Docker periodically checks if database is ready
    # pg_isready is a PostgreSQL utility that checks if server is accepting connections
    # ${DB_USER} is substituted with the database user from .env
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]   # Health check command
      interval: 10s                                      # Check every 10 seconds
      timeout: 5s                                        # Timeout after 5 seconds
      retries: 5                                         # Retry 5 times before marking unhealthy

  # ----------------------------------------
  # Redis Cache Service (In-Memory Cache)
  # ----------------------------------------
  redis:
    # Redis 7 Alpine image (lightweight caching server)
    image: redis:7-alpine
    
    # Container name with APP_NAME substitution
    container_name: ${APP_NAME:-myapp}_redis
    
    # Port mapping for Redis
    # ${REDIS_PORT:-6379}:6379 exposes Redis on custom port or default 6379
    ports:
      - "${REDIS_PORT:-6379}:6379"                      # Redis port (default: 6379)
    
    # Named volume for Redis data persistence
    # redis_data persists cache data across container restarts
    volumes:
      - redis_data:/data                                 # Redis data directory
    
    # Auto-restart policy
    restart: unless-stopped
    
    # Network connection for service communication
    networks:
      - app-network

# ============================================
# Networks Configuration
# ============================================
# Networks allow containers to communicate with each other
# Containers on the same network can reach each other by service name
networks:
  app-network:
    driver: bridge                                       # Bridge network (default)
                                                         # Allows containers to communicate via service names

# ============================================
# Volumes Configuration
# ============================================
# Named volumes provide persistent storage that survives container removal
# Data is stored in Docker's volume directory
volumes:
  postgres_data:                                        # Persistent storage for PostgreSQL data
                                                         # Survives container restarts/removals
  redis_data:                                           # Persistent storage for Redis data
                                                         # Cache data persists across restarts

